# HTTPS/SSL Ingress Configuration with TLS termination
# This creates an ALB with SSL certificate and HTTP to HTTPS redirect
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: 3-tier-app-eks-ingress
  namespace: 3-tier-app-eks
  annotations:
    # Create an internet-facing ALB (public access)
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    # Use IP mode for better compatibility with Fargate and pod networking
    alb.ingress.kubernetes.io/target-type: "ip"
    # Health check path - ALB will check this endpoint for service health
    alb.ingress.kubernetes.io/healthcheck-path: "/"

    # SSL/TLS Configuration
    # Listen on both HTTP (80) and HTTPS (443) ports
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    # Automatically redirect HTTP traffic to HTTPS
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    
    # SSL Security Policy - ensures strong encryption
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    # AWS ACM Certificate ARN - replace with your certificate ARN
    # NOTE: Ensure this certificate covers your domain and is in the correct AWS region
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:879381241087:certificate/328d88fa-8f47-47e2-b605-1b516180835f
    
    # HTTP to HTTPS redirect action configuration
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": {"Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
    
spec:
  # Use the ALB ingress class defined above
  ingressClassName: "alb"
  
  # TLS configuration for certificate management
  tls:
  - hosts:
    - "app.akhileshmishra.tech"  # Your app subdomain
    secretName: example-com-tls  # Must match Certificate resource secretName (use wildcard cert)
  
  rules:
  # Single subdomain rule - all traffic for app.akhileshmishra.tech
  - host: "app.akhileshmishra.tech"  # Your app subdomain
    http:
      paths:
      # Route API calls to backend service (must come first for priority)
      - path: /api
        pathType: Prefix  # Matches /api, /api/, /api/users, etc.
        backend:
          service:
            name: backend
            port:
              number: 8000
      # Route all other traffic to frontend
      - path: /
        pathType: Prefix  # Matches everything else (root, /login, /dashboard, etc.)
        backend:
          service:
            name: frontend
            port:
              number: 80
              
  # Optional: Add main domain redirect to subdomain (uncomment if needed)
  # - host: "akhileshmishra.tech"
  #   http:
  #     paths:
  #     - path: /
  #       pathType: Prefix
  #       backend:
  #         service:
  #           name: frontend  # or create a redirect service
  #           port:
  #             number: 80